#!/bin/bash
# Complete Password Reset Setup Script

echo "üéâ Password Reset System - Complete Setup"
echo "=========================================="
echo ""

cd ~/src/renterinsight_api

echo "üì¶ Step 1: Running Migrations..."
bundle exec rails db:migrate
if [ $? -ne 0 ]; then
    echo "‚ùå Migration failed!"
    exit 1
fi
echo "‚úÖ Migrations complete!"
echo ""

echo "üë• Step 2: Creating Test Users..."
bundle exec rails runner create_test_users_password_reset.rb
if [ $? -ne 0 ]; then
    echo "‚ùå User creation failed!"
    exit 1
fi
echo ""

echo "‚öôÔ∏è  Step 3: Settings Configuration"
echo "=========================================="
echo ""
echo "üìß EMAIL CONFIGURATION (Optional - for real delivery)"
echo "To send real emails, configure SMTP in Rails console:"
echo ""
echo "bin/rails console"
echo ""
echo "Setting.set('Platform', 0, 'communications', {"
echo "  email: {"
echo "    provider: 'smtp',"
echo "    fromEmail: 't+admin@renterinsight.com',"
echo "    fromName: 'RenterInsight',"
echo "    smtpHost: 'smtp.gmail.com',"
echo "    smtpPort: 587,"
echo "    smtpUsername: 't+admin@renterinsight.com',"
echo "    smtpPassword: 'your_gmail_app_password',"
echo "    isEnabled: true"
echo "  }"
echo "})"
echo ""
echo "üì± SMS CONFIGURATION (Optional - for real delivery)"
echo "To send real SMS, add Twilio settings:"
echo ""
echo "Setting.set('Platform', 0, 'communications', {"
echo "  sms: {"
echo "    provider: 'twilio',"
echo "    fromNumber: '+13035709810',"
echo "    twilioAccountSid: 'your_twilio_sid',"
echo "    twilioAuthToken: 'your_twilio_token',"
echo "    isEnabled: true"
echo "  }"
echo "})"
echo ""
echo "=========================================="
echo ""
echo "‚úÖ SETUP COMPLETE!"
echo ""
echo "üß™ TEST THE SYSTEM:"
echo "=========================================="
echo ""
echo "1Ô∏è‚É£  Test Admin Email Reset:"
echo "curl -X POST http://localhost:3001/api/auth/request_password_reset \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -d '{"
echo "    \"email\": \"t+admin@renterinsight.com\","
echo "    \"delivery_method\": \"email\","
echo "    \"user_type\": \"admin\""
echo "  }'"
echo ""
echo "2Ô∏è‚É£  Test Client Email Reset:"
echo "curl -X POST http://localhost:3001/api/auth/request_password_reset \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -d '{"
echo "    \"email\": \"t+client@renterinsight.com\","
echo "    \"delivery_method\": \"email\","
echo "    \"user_type\": \"client\""
echo "  }'"
echo ""
echo "3Ô∏è‚É£  Test Admin SMS Reset (Phone):"
echo "curl -X POST http://localhost:3001/api/auth/request_password_reset \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -d '{"
echo "    \"phone\": \"+13035709810\","
echo "    \"delivery_method\": \"sms\","
echo "    \"user_type\": \"admin\""
echo "  }'"
echo ""
echo "4Ô∏è‚É£  Test Client SMS Reset (Phone):"
echo "curl -X POST http://localhost:3001/api/auth/request_password_reset \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -d '{"
echo "    \"phone\": \"+13035709810\","
echo "    \"delivery_method\": \"sms\","
echo "    \"user_type\": \"client\""
echo "  }'"
echo ""
echo "=========================================="
echo "üéâ Ready to test password reset!"
